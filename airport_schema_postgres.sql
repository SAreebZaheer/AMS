-- Airport Management System for PostgreSQL --

CREATE TABLE CITY (
    CNAME VARCHAR(15) NOT NULL,
    STATE VARCHAR(15), 
    COUNTRY VARCHAR(30),
    PRIMARY KEY(CNAME)
);

INSERT INTO CITY (CNAME, STATE, COUNTRY) VALUES
('Louisville','Kentucky','United States'),
('Chandigarh','Chandigarh','India'),
('Fort Worth','Texas','United States'),
('Delhi','Delhi','India'),
('Mumbai','Maharashtra','India'),
('San Francisco', 'California', 'United States'),
('Frankfurt','Hesse','Germany'),
('Houston','Texas','United States'),
('New York City','New York','United States'),
('Tampa', 'Florida', 'United States');

CREATE TABLE AIRPORT (
    AP_NAME VARCHAR(100) NOT NULL,
    STATE VARCHAR(15), 
    COUNTRY VARCHAR(30),
    CNAME VARCHAR(15),
    PRIMARY KEY(AP_NAME),
    FOREIGN KEY(CNAME) REFERENCES CITY(CNAME) ON DELETE CASCADE
);

INSERT INTO AIRPORT (AP_NAME, STATE, COUNTRY, CNAME) VALUES
('Louisville International Airport','Kentucky','United States','Louisville'),
('Chandigarh International Airport','Chandigarh','India','Chandigarh'),
('Dallas/Fort Worth International Airport','Texas','United States','Fort Worth'),
('Indira GandhiInternational Airport','Delhi','India','Delhi'),
('Chhatrapati Shivaji International Airport','Maharashtra','India','Mumbai'),
('San Francisco International Airport','California', 'United States','San Francisco'),
('Frankfurt Airport','Hesse','Germany','Frankfurt'),
('George Bush Intercontinental Airport','Texas','United States','Houston'),
('John F. Kennedy International Airport','New York','United States','New York City'),
('Tampa International Airport','Florida', 'United States','Tampa');

CREATE TABLE AIRLINE (
    AIRLINEID VARCHAR(3) NOT NULL,
    AL_NAME VARCHAR(50),
    THREE_DIGIT_CODE VARCHAR(3),
    PRIMARY KEY(AIRLINEID)
);

INSERT INTO AIRLINE (AIRLINEID, AL_NAME, THREE_DIGIT_CODE) VALUES
('AA','American Airlines','001'),
('AI','Air India Limited','098'),
('LH','Lufthansa', '220'),
('BA','British Airways','125'),
('QR','Qatar Airways','157'),
('9W','Jet Airways','589'),
('EK','Emirates','176'),
('EY','Ethiad Airways','607');

CREATE TABLE CONTAINS (
    AIRLINEID VARCHAR(3) NOT NULL,
    AP_NAME VARCHAR(100) NOT NULL,
    PRIMARY KEY(AIRLINEID, AP_NAME),
    FOREIGN KEY(AIRLINEID) REFERENCES AIRLINE(AIRLINEID) ON DELETE CASCADE,
    FOREIGN KEY(AP_NAME) REFERENCES AIRPORT(AP_NAME) ON DELETE CASCADE
);

INSERT INTO CONTAINS (AIRLINEID, AP_NAME) VALUES
('AA','Louisville International Airport'),
('AA','John F. Kennedy International Airport'),
('AA','George Bush Intercontinental Airport'),
('AA','San Francisco International Airport'),
('AA','Tampa International Airport'),
('AI','Chandigarh International Airport'),
('AI','Dallas/Fort Worth International Airport'),
('AI','Indira GandhiInternational Airport'),
('AI','Chhatrapati Shivaji International Airport'),
('AI','George Bush Intercontinental Airport'),
('LH','Chhatrapati Shivaji International Airport'),
('LH','Frankfurt Airport'),
('LH','John F. Kennedy International Airport'),
('LH','San Francisco International Airport'),
('LH','Dallas/Fort Worth International Airport'),
('BA','John F. Kennedy International Airport'),
('BA','Chhatrapati Shivaji International Airport'),
('BA','Chandigarh International Airport'),
('BA','Frankfurt Airport'),
('BA','San Francisco International Airport'),
('QR','Chhatrapati Shivaji International Airport'),
('QR','Dallas/Fort Worth International Airport'),
('QR','John F. Kennedy International Airport'),
('QR','Tampa International Airport'),
('QR','Louisville International Airport');

CREATE TABLE FLIGHT (
    FLIGHT_CODE VARCHAR(10) NOT NULL,
    SOURCE VARCHAR(3),
    DESTINATION VARCHAR(3),
    ARRIVAL VARCHAR(10),
    DEPARTURE VARCHAR(10),
    STATUS VARCHAR(10),
    DURATION VARCHAR(30),
    FLIGHTTYPE VARCHAR(10),
    LAYOVER_TIME VARCHAR(30),
    NO_OF_STOPS INT,
    AIRLINEID VARCHAR(3),
    PRIMARY KEY(FLIGHT_CODE),
    FOREIGN KEY(AIRLINEID) REFERENCES AIRLINE(AIRLINEID) ON DELETE CASCADE
);

INSERT INTO FLIGHT VALUES
('AI2014','BOM','DFW','02:10','03:15','On-time','24hr','Connecting','3',1,'AI'),
('QR2305','BOM','DFW','13:00','13:55','Delayed','21hr','Non-stop','0',0,'QR'),
('EY1234','JFK','TPA','19:20','20:05','On-time','16hrs','Connecting','5',2,'EY'),
('LH9876','JFK','BOM','05:50','06:35','On-time','18hrs','Non-stop','0',0,'LH'),
('BA1689','FRA','DEL','10:20','10:55','On-time','14hrs','Non-stop','0',0,'BA'),
('AA4367','SFO','FRA','18:10','18:55','On-time','21hrs','Non-stop','0',0,'AA'),
('QR1902','IXC','IAH','22:00','22:50','Delayed','28hrs','Non-stop','5',1,'QR'),
('BA3056','BOM','DFW','02:15','02:55','On-time','29hrs','Connecting','3',1,'BA'),
('EK3456','BOM','SFO','18:50','19:40','On-time','30hrs','Non-stop','0',0,'EK'),
('9W2334','IAH','DEL','23:00','13:45','On-time','23hrs','Direct','0',0,'9W');

CREATE TABLE PASSENGER1 (
    PID INT NOT NULL,
    PASSPORTNO VARCHAR(10) NOT NULL,
    PRIMARY KEY(PID, PASSPORTNO)
);

INSERT INTO PASSENGER1 VALUES
(1,'A1234568'),
(2,'B9876541'),
(3,'C2345698'),
(4,'D1002004'),
(5,'X9324666'),
(6,'B8765430'),
(7,'J9801235'),
(8,'A1122334'),
(9,'Q1243567'),
(10,'S1243269'),
(11,'E3277889'),
(12,'K3212322'),
(13,'P3452390'),
(14,'W7543336'),
(15,'R8990566');

CREATE TABLE PASSENGER2 (
    PASSPORTNO VARCHAR(10) NOT NULL,
    FNAME VARCHAR(20),
    M VARCHAR(1),
    LNAME VARCHAR(20),
    ADDRESS VARCHAR(100),
    PHONE BIGINT,
    AGE INT,
    SEX VARCHAR(1),
    PRIMARY KEY(PASSPORTNO)
);

INSERT INTO PASSENGER2 VALUES
('A1234568','ALEN','M','SMITH','2230 NORTHSIDE, APT 11, ALBANY, NY',8080367290,30,'M'),
('B9876541','ANKITA','V','AHIR','3456 VIKAS APTS, APT 102,DOMBIVLI, INDIA',8080367280,26,'F'),
('C2345698','KHYATI','A','MISHRA','7820 MCCALLUM COURTS, APT 234, AKRON, OH',8082267280,30,'F'),
('D1002004','ANKITA','S','PATIL','7720 MCCALLUM BLVD, APT 1082, DALLAS, TX',9080367266,23,'F'),
('X9324666','TEJASHREE','B','PANDIT','9082 ESTAES OF RICHARDSON, RICHARDSON, TX',9004360125,28,'F'),
('B8765430','LAKSHMI','P','SHARMA','1110 FIR HILLS, APT 903, AKRON, OH',7666190505,30,'F'),
('J9801235','AKHILESH','D','JOSHI','345 CHATHAM COURTS, APT 678, MUMBAI, INDIA',9080369290,29,'M'),
('A1122334','MANAN','S','LAKHANI','5589 CHTHAM REFLECTIONS, APT 349 HOUSTON, TX',9004335126,25,'F'),
('Q1243567','KARAN','M','MOTANI','4444 FRANKFORD VILLA, APT 77, GUILDERLAND, NY',9727626643,22,'M'),
('S1243269','ROM','A','SOLANKI','7720 MCCALLUM BLVD, APT 2087, DALLAS, TX',9004568903,60,'M'),
('E3277889','John','A','GATES','1234 BAKER APTS, APT 59, HESSE, GERMANY',9724569986,10,'M'),
('K3212322','SARA','B','GOMES','6785 SPLITSVILLA, APT 34, MIAMI, FL',9024569226,15,'F'),
('P3452390','ALIA','V','BHAT','548 MARKET PLACE, SAN Francisco, CA',9734567800,10,'F'),
('W7543336','JOHN','P','SMITH','6666 ROCK HILL, APT 2902, TAMPA, FL',4624569986,55,'M'),
('R8990566','RIA','T','GUPTA','3355 PALENCIA, APT 2065, MUMBAI, INDIA',4724512343,10,'M');

CREATE TABLE PASSENGER3 (
    PID INT NOT NULL,
    FLIGHT_CODE VARCHAR(10),
    PRIMARY KEY(PID),
    FOREIGN KEY(FLIGHT_CODE) REFERENCES FLIGHT(FLIGHT_CODE) ON DELETE CASCADE
);

INSERT INTO PASSENGER3 VALUES
(1,'AI2014'),
(2,'LH9876'),
(3,'9W2334'),
(4,'QR1902'),
(5,'EY1234'),
(6,'BA3056'),
(7,'9W2334'),
(8,'AA4367'),
(9,'QR1902'),
(10,'EK3456'),
(11,'BA1689'),
(12,'QR1902'),
(13,'AI2014'),
(14,'BA1689'),
(15,'QR2305');

CREATE TABLE EMPLOYEE1 (
    SSN INT NOT NULL,
    FNAME VARCHAR(20),
    M VARCHAR(1),
    LNAME VARCHAR(20),
    ADDRESS VARCHAR(100),
    PHONE BIGINT,
    AGE INT,
    SEX VARCHAR(1),
    JOBTYPE VARCHAR(30),
    ASTYPE VARCHAR(30),
    ETYPE VARCHAR(30),
    SHIFT VARCHAR(20),
    POSITION VARCHAR(30),
    AP_NAME VARCHAR(100),
    PRIMARY KEY(SSN),
    FOREIGN KEY(AP_NAME) REFERENCES AIRPORT(AP_NAME) ON DELETE CASCADE
);

INSERT INTO EMPLOYEE1 VALUES
(123456789,'LINDA','M','GOODMAN','731 Fondren, Houston, TX',4356789345,35,'F','ADMINISTRATIVE SUPPORT','RECEPTIONIST',NULL,NULL,NULL,'Louisville International Airport'),
(333445555,'JOHNY','N','PAUL','638 Voss, Houston, TX',9834561995,40,'M','ADMINISTRATIVE SUPPORT','SECRETARY',NULL,NULL,NULL,'Louisville International Airport'),
(999887777,'JAMES','P','BOND','3321 Castle, Spring, TX',9834666995,50,'M','ENGINEER',NULL,'RADIO ENGINEER',NULL,NULL,'Louisville International Airport'),
(987654321,'SHERLOCK','A','HOLMES','123 TOP HILL, SAN Francisco,CA',8089654321,47,'M','TRAFFIC MONITOR',NULL,NULL,'DAY',NULL,'San Francisco International Airport'),
(666884444,'SHELDON','A','COOPER','345 CHERRY PARK, HESSE,GERMANY',1254678903,55,'M','TRAFFIC MONITOR',NULL,NULL,'NIGHT',NULL,'Frankfurt Airport'),
(453453453,'RAJ','B','SHARMA','345 FLOYDS, MUMBAI,INDIA',4326789031,35,'M','AIRPORT AUTHORITY',NULL,NULL,NULL,'MANAGER','Chhatrapati Shivaji International Airport'),
(987987987,'NIKITA','C','PAUL','110 SYNERGY PARK, DALLAS,TX',5678904325,33,'F','ENGINEER',NULL,'AIRPORT CIVIL ENGINEER',NULL,NULL,'Dallas/Fort Worth International Airport'),
(888665555,'SHUBHAM','R','GUPTA','567 CHANDANI CHOWK, DELHI, INDIA',8566778890,39,'M','ADMINISTRATIVE SUPPORT','DATA ENTRY WORKER',NULL,NULL,NULL,'Indira GandhiInternational Airport'),
(125478909,'PRATIK','T','GOMES','334 VITRUVIAN PARK, ALBANY, NY',4444678903,56,'M','TRAFFIC MONITOR',NULL,NULL,'DAY',NULL,'John F. Kennedy International Airport'),
(324567897,'ADIT','P','DESAI','987 SOMNATH, CHANDIGARH, INDIA',2244658909,36,'M','TRAFFIC MONITOR',NULL,NULL,'DAY',NULL,'Chandigarh International Airport');

CREATE TABLE EMPLOYEE2 (
    JOBTYPE VARCHAR(30) NOT NULL,
    SALARY INT,
    PRIMARY KEY(JOBTYPE)
);

INSERT INTO EMPLOYEE2 VALUES
('ADMINISTRATIVE SUPPORT',50000),
('ENGINEER',70000),
('TRAFFIC MONITOR',80000),
('AIRPORT AUTHORITY',90000);

CREATE TABLE SERVES (
    SSN INT NOT NULL,
    PID INT NOT NULL,
    PASSPORTNO VARCHAR(10) NOT NULL,
    PRIMARY KEY(SSN, PID, PASSPORTNO),
    FOREIGN KEY(SSN) REFERENCES EMPLOYEE1(SSN) ON DELETE CASCADE,
    FOREIGN KEY(PID, PASSPORTNO) REFERENCES PASSENGER1(PID, PASSPORTNO) ON DELETE CASCADE
);

INSERT INTO SERVES VALUES
(123456789,1,'A1234568'),
(123456789,15,'R8990566'),
(123456789,9,'Q1243567'),
(888665555,4,'D1002004'),
(888665555,13,'P3452390'),
(333445555,10,'S1243269'),
(333445555,12,'K3212322'),
(888665555,12,'K3212322'),
(123456789,7,'J9801235'),
(888665555,7,'J9801235');

CREATE TABLE TICKET1 (
    TICKET_NUMBER BIGINT NOT NULL,
    SOURCE VARCHAR(3),
    DESTINATION VARCHAR(3),
    DATE_OF_BOOKING DATE,
    DATE_OF_TRAVEL DATE,
    SEATNO VARCHAR(5),
    CLASS VARCHAR(15),
    DATE_OF_CANCELLATION DATE,
    PID INT,
    PASSPORTNO VARCHAR(10),
    FOREIGN KEY(PID, PASSPORTNO) REFERENCES PASSENGER1(PID, PASSPORTNO) ON DELETE CASCADE
);

INSERT INTO TICKET1 VALUES
(0011234111122,'BOM','DFW','2016-05-11',NULL,'2016-12-15','32A','ECONOMY',NULL,1,'A1234568'),
(0984567222299,'JFK','BOM','2016-06-11','2016-12-10','2016-12-20','45D','ECONOMY',NULL,2,'B9876541'),
(1768901333273,'IAH','DEL','2016-08-21',NULL,'2016-12-25','1A','BUSINESS',NULL,3,'C2345698'),
(5890987441464,'IXC','IAH','2016-08-10',NULL,'2017-01-12','20C','FIRST-CLASS',NULL,4,'D1002004'),
(1577654664266,'JFK','TPA','2016-06-13',NULL,'2016-12-10','54E','ECONOMY',NULL,5,'X9324666'),
(2206543545545,'BOM','DFW','2016-11-11',NULL,'2017-02-12','43B','ECONOMY',NULL,6,'B8765430'),
(7064321779737,'IAH','DEL','2016-11-15',NULL,'2016-12-25','27B','FIRST-CLASS',NULL,7,'J9801235'),
(1571357215116,'SFO','FRA','2016-10-15',NULL,'2016-12-18','34E','ECONOMY',NULL,8,'A1122334'),
(1570864987655,'IXC','IAH','2016-11-12',NULL,'2016-12-30','54C','ECONOMY',NULL,9,'Q1243567'),
(1579283997799,'BOM','SFO','2016-01-22',NULL,'2016-12-15','38A','ECONOMY',NULL,10,'S1243269'),
(1255701876107,'FRA','DEL','2016-10-19',NULL,'2016-12-31','57F','ECONOMY',NULL,11,'E3277889'),
(1251334499699,'IXC','IAH','2016-11-20',NULL,'2017-01-12','45D','ECONOMY',NULL,12,'K3212322'),
(1258776199490,'BOM','DFW','2016-05-13','2016-05-25','2016-12-15','37C','ECONOMY',NULL,13,'P3452390'),
(5891155114477,'FRA','DEL','2016-06-26',NULL,'2016-12-23','55C','ECONOMY',NULL,14,'W7543336'),
(5893069766787,'BOM','DFW','2016-08-11',NULL,'2016-12-22','33F','ECONOMY',NULL,15,'R8990566');

CREATE TABLE TICKET2 (
    DATE_OF_BOOKING DATE NOT NULL,
    SOURCE VARCHAR(3) NOT NULL,
    DESTINATION VARCHAR(3) NOT NULL,
    CLASS VARCHAR(15) NOT NULL,
    PRICE INT,
    PRIMARY KEY(DATE_OF_BOOKING, SOURCE, DESTINATION, CLASS)
);

INSERT INTO TICKET2 VALUES
('2016-05-11','BOM','DFW','ECONOMY',95000),
('2016-06-11','JFK','BOM','ECONOMY',100000),
('2016-08-21','IAH','DEL','BUSINESS',200000),
('2016-08-10','IXC','IAH','FIRST-CLASS',150000),
('2016-06-13','JFK','TPA','ECONOMY',98000),
('2016-11-11','BOM','DFW','ECONOMY',125000),
('2016-11-15','IAH','DEL','FIRST-CLASS',195000),
('2016-10-15','SFO','FRA','ECONOMY',170000),
('2016-11-12','IXC','IAH','ECONOMY',140000),
('2016-01-22','BOM','SFO','ECONOMY',45000),
('2016-10-19','FRA','DEL','ECONOMY',100000),
('2016-11-20','IXC','IAH','ECONOMY',120000),
('2016-05-13','BOM','DFW','ECONOMY',65000),
('2016-06-26','FRA','DEL','ECONOMY',80000),
('2016-08-11','BOM','DFW','ECONOMY',98000);

CREATE TABLE TICKET3 (
    DATE_OF_CANCELLATION DATE NOT NULL,
    SURCHARGE INT,
    PRIMARY KEY(DATE_OF_CANCELLATION)
);

INSERT INTO TICKET3 VALUES
('2016-12-10',75000),
('2016-05-25',25000);

-- Create stored procedures as PostgreSQL functions
CREATE OR REPLACE FUNCTION dfw_economy_passengers()
RETURNS TABLE (
    airline_name VARCHAR(50),
    flight_code VARCHAR(10),
    first_name VARCHAR(20),
    last_name VARCHAR(20),
    passport_no VARCHAR(10),
    class VARCHAR(15),
    source VARCHAR(3),
    seat_no VARCHAR(5),
    ticket_number BIGINT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        al.AL_NAME, 
        fl.FLIGHT_CODE,
        p2.FNAME,
        p2.LNAME,
        p2.PASSPORTNO,
        t.CLASS,
        t.SOURCE,
        t.SEATNO,
        t.TICKET_NUMBER
    FROM 
        Airline al
        JOIN Flight fl ON al.AIRLINEID = fl.AIRLINEID
        JOIN PASSENGER3 p3 ON fl.FLIGHT_CODE = p3.FLIGHT_CODE
        JOIN PASSENGER1 p1 ON p1.PID = p3.PID
        JOIN PASSENGER2 p2 ON p1.PASSPORTNO = p2.PASSPORTNO
        JOIN TICKET1 t ON t.PASSPORTNO = p2.PASSPORTNO AND t.PID = p1.PID
    WHERE 
        t.CLASS = 'ECONOMY' AND t.DESTINATION = 'DFW';
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION flights_by_status(IN_STATUS VARCHAR)
RETURNS TABLE (
    flight_code VARCHAR(10),
    airline_name VARCHAR(50),
    arrival VARCHAR(10),
    departure VARCHAR(10),
    source VARCHAR(3),
    destination VARCHAR(3),
    status VARCHAR(10),
    flight_type VARCHAR(10)
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        f.FLIGHT_CODE,
        al.AL_NAME,
        f.ARRIVAL,
        f.DEPARTURE,
        f.SOURCE,
        f.DESTINATION,
        f.STATUS,
        f.FLIGHTTYPE
    FROM 
        Airline al
        JOIN Flight f ON al.AIRLINEID = f.AIRLINEID
    WHERE 
        f.STATUS = IN_STATUS;
END;
$$ LANGUAGE plpgsql;

-- Create tables for triggers
CREATE TABLE DELAYED_FLIGHTS (
    FLIGHT_CODE VARCHAR(20),
    DESTINATION VARCHAR(20),
    SOURCE VARCHAR(20),
    AIRLINEID VARCHAR(20),
    REPORT_TIME TIMESTAMP
);

CREATE TABLE TICKET_PRICE_HISTORY (
    DATE_OF_BOOKING DATE NOT NULL,
    SOURCE VARCHAR(3) NOT NULL,
    DESTINATION VARCHAR(3) NOT NULL,
    CLASS VARCHAR(15) NOT NULL,
    PRICE INT,
    PRIMARY KEY(DATE_OF_BOOKING, SOURCE, DESTINATION, CLASS)
);

-- Create triggers
CREATE OR REPLACE FUNCTION delayed_flights_trigger()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.STATUS = 'Delayed' THEN
        INSERT INTO DELAYED_FLIGHTS (FLIGHT_CODE, SOURCE, DESTINATION, AIRLINEID, REPORT_TIME)
        VALUES (NEW.FLIGHT_CODE, NEW.SOURCE, NEW.DESTINATION, NEW.AIRLINEID, NOW());
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER delayed_flights
AFTER INSERT OR UPDATE ON FLIGHT
FOR EACH ROW
EXECUTE FUNCTION delayed_flights_trigger();

CREATE OR REPLACE FUNCTION ticket_price_history_trigger()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO TICKET_PRICE_HISTORY 
    VALUES (OLD.DATE_OF_BOOKING, OLD.SOURCE, OLD.DESTINATION, OLD.CLASS, OLD.PRICE);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER ticket_price_history
BEFORE UPDATE OF PRICE ON TICKET2
FOR EACH ROW
EXECUTE FUNCTION ticket_price_history_trigger();